- name: "setup terminal | packages"
  apt:
    name:
    - bash-completion
    - binutils
    update_cache: yes
  tags: packages, apt

- name: "setup terminal | vim configuration"
  blockinfile:
    marker: '" {mark} ANSIBLE MANAGED BLOCK'
    path: ~/.vimrc
    create: yes
    block: |
      colorscheme ron
      set tabstop=2
      set shiftwidth=2
      set expandtab
      set autoindent

- name: "setup terminal | bash configuration"
  blockinfile:
    path: ~/.bashrc
    block: |
      source <(kubectl completion bash)
      alias k=kubectl
      alias c=clear
      complete -F __start_kubectl k
  tags: bash

- name: "setup terminal | bash configuration"
  replace:
    path: ~/.bashrc
    regexp: '^#(force_color_prompt=yes)$'
    replace: '\1'
  tags: bash

- name: "tools | include exam additionnal tools"
  ansible.builtin.include_tasks:
    file: additionnal_tools.yml

- name: "disable swap | disable swap"
  shell: swapoff -a
  when: ansible_swaptotal_mb > 0
  tags: swap

- name: "disable swap | comment swap partition in fstab"
  ansible.posix.mount:
    path: none
    fstype: swap
    state: absent
  tags: swap

- name: "apt | keyrings directory"
  file:
    path: /etc/apt/keyrings
    state: directory
  tags: packages, apt

- name: "podman | install and configure podman"
  ansible.builtin.include_tasks:
    file: podman.yml

- name: "packages | kubernetes repo"
  ansible.builtin.deb822_repository:
    name: kubernetes
    types: [deb]
    uris: "https://pkgs.k8s.io/core:/stable:/v1.28/deb/"
    signed_by: "https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key"
    suites: [/]
    state: present
    enabled: true
  tags: packages, apt

- name: "packages | kubernetes packages"
  apt:
    name:
    - "kubelet={{ KUBERNETES_VERSION }}-1.1"
    - "kubeadm={{ KUBERNETES_VERSION }}-1.1"
    - "kubectl={{ KUBERNETES_VERSION }}-1.1"
    - kubernetes-cni
    state: present
    update_cache: yes
  tags: packages, apt

- name: "packages | hold kubernetes packages"
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  with_items:
  - kubelet
  - kubectl
  - kubeadm
  - kubernetes-cni
  tags: packages, apt

- name: "gvisor | install and configure gvisor"
  ansible.builtin.include_tasks:
    file: gvisor.yml
  when: gvisor.enabled

- name: "containerd | install and configure containerd"
  ansible.builtin.include_tasks:
    file: containerd.yml

  # TODO: use handlers ?
- name: "services | kubelet enabled and started"
  ansible.builtin.systemd:
    name: kubelet
    state: started
    daemon_reload: yes
    enabled: yes
  tags: kubelet

- name: "course | git clone cks course repository"
  ansible.builtin.git:
    repo: https://github.com/killer-sh/cks-course-environment.git
    dest: /root/cks-course-environment

- name: "falco | install and run falco"
  ansible.builtin.include_tasks:
    file: falco.yml
  when: falco.enabled

- name: "kube-bench | install kube-bench"
  ansible.builtin.include_tasks:
    file: kube-bench.yml
  when: kube_bench.enabled
